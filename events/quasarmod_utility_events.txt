namespace = quasarmod_utility

# Set quasarmod_enabled global flag
event  = {
    id = quasarmod_utility.1
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        set_global_flag = quasarmod_enabled
    }
}

# Replace Planetcraft built at the Teraforge with a version that shouldn't have the fleet splitting bug
ship_event = {
    id = quasarmod_utility.2
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = {
                is_ship_size = giga_planet_behemoth
                not = {
                    has_ship_flag = giga_planet

                }
            }
            create_fleet = {
                name = "Behemoth Planetcraft"
                settings = {
                    spawn_debris = no
                    #is_boss = yes
                    can_change_composition = no
                }
                effect = {
                    set_owner = prev
                    create_ship = {
                        name = "Behemoth Planetcraft"
                        random_existing_design = giga_planet_behemoth
                        effect = {
                            set_ship_flag = random
                            add_modifier = {
                                modifier = printed_celestial_warship
                                days = -1
                            }
                            set_name = {
                                key = "war_planet_printed_ship_name"
                            }
                        }
                    }
                    set_formation_scale = 10
                    set_location = {
                        target = fromfrom
                        distance = 20
                        angle = 0
                    }
                }
            }

            delete_ship = this
        }
    }
}

# Monthly pulse event to remove the core mbrain flag/modifier under certain conditions
country_event = {
    id = quasarmod_utility.3
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        every_owned_planet = {
            if = {
                limit = {
                    OR = {
                        owner = { not = { any_owned_megastructure = { is_megastructure_type = matrioshka_brain_5_core} } }
                        NOR = {
                            has_building = building_giga_matrioshka_brain_uplink_research
                            has_building = building_giga_matrioshka_brain_uplink_unity
                            has_building = building_giga_matrioshka_brain_uplink_sanctuary
                            has_building = building_giga_matrioshka_brain_uplink_entertainment
                            has_building = building_giga_matrioshka_brain_uplink_training
                            has_building = building_giga_matrioshka_brain_uplink_diplomacy
                            has_building = building_giga_matrioshka_brain_uplink_hell
                            has_building = building_giga_matrioshka_brain_uplink_livestock
                            has_building = building_giga_matrioshka_brain_uplink_amalgamation
                            has_building = building_giga_matrioshka_brain_uplink_foundry
                            has_building = building_giga_matrioshka_brain_uplink_factory
                            has_building = building_giga_matrioshka_brain_uplink_refinery
                            has_building = building_giga_matrioshka_brain_uplink_anti_deviancy
                            has_building = building_giga_matrioshka_brain_uplink_robot
                            has_building = building_giga_matrioshka_brain_uplink_virtual  }
                    }
                    is_colony = yes
                }
                remove_modifier = quasarmod_connected_to_core_mbrain_mod
                remove_planet_flag = connected_to_core_mbrain
            }
        }
    }
}

# Harvesting Complete - turn Quasar into inactive SMBH
planet_event = {
    id = quasarmod_utility.4
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        change_pc = pc_core_black_hole
        solar_system = {
            set_star_class = sc_birch
            every_system_planet = {
                remove_planet_flag = has_megastructure

                limit = {
                    nor = {
                        is_planet_class = pc_core_quasar
                        is_planet_class = pc_core_black_hole
                    }
                }
                change_pc = pc_barren
            }

            every_system_megastructure = {
                limit = {
                    nor = {
                        is_megastructure_type = lgate_base
                        is_megastructure_type = gateway_final
                        is_megastructure_type = gateway_restored
                        is_megastructure_type = ehof_pgate_gateway
                        is_megastructure_type = hyper_relay
                        is_megastructure_type = hyper_relay_restored
                    }
                }
                remove_megastructure = this
            }

            star = {
                giga_clear_has_mega_flag = yes
                change_pc = pc_core_black_hole
                set_planet_size = 20
                #test fix for EHOF bug - consider not removing star flags to prevent spam of new core systems (this needs to be tested)
                if = {
                    limit = {
                        solar_system = {
                            or = {
                                has_star_flag = giga_core_02
                                has_star_flag = giga_qso_core
                            }
                        }
                    }
                    solar_system = {
                        remove_star_flag = giga_core_02
                        remove_star_flag = giga_qso_core
                        set_star_flag = giga_core_01
                        set_star_flag = giga_birch_core
                    }
                }
            }
        }

        space_owner = {
            country_event = {
                id = quasarmod_dialogue.202
            }
        }
    }
}

# Harvesting Complete - turn inactive SMBH into Quasar
planet_event = {
    id = quasarmod_utility.5
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        change_pc = pc_core_quasar
        solar_system = {
            set_star_class = sc_quasar
            every_system_planet = {
                remove_planet_flag = has_megastructure

                limit = {
                    nor = {
                        is_planet_class = pc_core_quasar
                        is_planet_class = pc_core_black_hole
                    }
                }
                change_pc = pc_molten
            }

            every_system_megastructure = {
                limit = {
                    nor = {
                        is_megastructure_type = lgate_base
                        is_megastructure_type = gateway_final
                        is_megastructure_type = gateway_restored
                        is_megastructure_type = ehof_pgate_gateway
                        is_megastructure_type = hyper_relay
                        is_megastructure_type = hyper_relay_restored
                    }
                }
                remove_megastructure = this
            }

            star = {
                giga_clear_has_mega_flag = yes
                change_pc = pc_core_quasar
                set_planet_size = 10
                #test fix for EHOF bug
                if = {
                    limit = {
                        solar_system = {
                            or = {
                                has_star_flag = giga_core_01
                                has_star_flag = giga_birch_core
                            }
                        }
                    }
                    solar_system = {
                        set_star_flag = giga_core_02
                        set_star_flag = giga_qso_core
                        remove_star_flag = giga_core_01
                        remove_star_flag = giga_birch_core
                    }
                }

            }
        }

        space_owner = {
            country_event = {
                id = quasarmod_dialogue.102
            }
        }
    }
}

# Set Quasarcraft Lives Variable
ship_event = {
    id = quasarmod_utility.6
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        save_global_event_target_as = quasarcraft_owner
        set_variable = {
            which = qsc_ship_life_count
            value = 200
        }
    }
}

# Destroy Quasarcraft if no lives
ship_event = {
    id = quasarmod_utility.7
    hide_window = yes
    is_triggered_only = yes

    trigger = {
        is_ship_size = quasarmod_quasarcraft
        check_variable = {
            which = qsc_ship_life_count
            value > 0
        }
    }

    immediate = {
        if = {
            limit = {
                check_variable = {
                    which = qsc_ship_life_count
                    value > 0
                }
            }
            repair_ship = yes
            set_disabled = no
            subtract_variable = {
                which = qsc_ship_life_count
                value = 1
            }
        }
        if = {
            limit = {
                check_variable = {
                    which = qsc_ship_life_count
                    value = 0
                }
            }
            destroy_ship = ROOT
            root.owner = {
                country_event = { id = quasarmod_dialogue.9 }
            }
        }
    }
}

# Quasarcraft Wormhole Stuff
ship_event = {
    id = quasarmod_utility.8
    hide_window = yes
    is_triggered_only = yes

    immediate = {
        if = {
            limit = { is_ship_size = quasarcraft_wormhole }
            destroy_ship = ROOT
            change_variable = {
                which = qsc_wormholes_count
                value = -1
            }
        }
    }
}